# Итерация 3: Улучшенная обработка текста
import re
from collections import defaultdict

def find_anagrams_in_text(text):
    """
    Основная функция для поиска анаграмм в тексте.
    Возвращает массив групп анаграмм.
    """
    # Очищаем текст
    cleaned_text = clean_text(text)
    
    # Получаем слова из текста
    words = get_words_from_text(cleaned_text)
    
    # Используем defaultdict для удобства
    anagram_groups = defaultdict(list)
    
    # Группируем слова по их нормализованной форме
    for word in words:
        if len(word) > 1:  # Игнорируем однобуквенные "слова"
            normalized = normalize_word(word)
            # Добавляем слово только если его еще нет в группе
            if word not in anagram_groups[normalized]:
                anagram_groups[normalized].append(word)
    
    # Фильтруем только группы с более чем одним словом
    result = [sorted(group) for group in anagram_groups.values() if len(group) > 1]
    
    # Сортируем результат для удобства
    result.sort(key=lambda x: (len(x[0]), x[0]))
    
    return result

def clean_text(text):
    """
    Очищает текст от лишних символов и знаков препинания.
    """
    # Удаляем все не-буквенные символы, кроме пробелов
    text = re.sub(r'[^a-zA-Zа-яА-ЯёЁ\s]', ' ', text)
    return text.lower()

def normalize_word(word):
    """
    Нормализует слово для сравнения (сортировка букв).
    """
    # Сортируем буквы в слове
    return ''.join(sorted(word.lower()))

def get_words_from_text(text):
    """
    Извлекает слова из текста.
    """
    # Разделяем текст по пробелам и удаляем пустые строки
    return [word for word in text.split() if word]

if __name__ == "__main__":
    # Тестовые примеры
    test_cases = [
        "кот ток кто",
        "лист столи тсил",
        "Hello world from Python!",
        "А роза упала на лапу Азора",
        "Слова: кот, ток, кто, отк, тко"
    ]
    
    for i, text in enumerate(test_cases, 1):
        print(f"Пример {i}:")
        print(f"Текст: '{text}'")
        result = find_anagrams_in_text(text)
        print(f"Анаграммы: {result}")
        print()